{"version":3,"sources":["../src/index.ts","../src/routes/auth.route.ts","../src/services/auth.service.ts","../src/config/db.ts","../src/services/chekcExists.ts"],"sourcesContent":["import express from \"express\";\nimport morgan from \"morgan\";\nimport session from \"express-session\";\nimport { createClient } from \"redis\";\nimport { RedisStore } from \"connect-redis\";\nimport routerAuth from \"./routes/auth.route.ts\";\nimport cors from \"cors\";\n\nconst redisClient = createClient({\n  url: process.env.REDIS_URL || \"redis://redis-service:6379\",\n});\nredisClient.connect().catch(console.error);\n\nconst redisStore = new RedisStore({\n  client: redisClient,\n  prefix: \"session\",\n});\n\nconst app: express.Application = express();\n\napp.use(cors({ origin: process.env.FRONTEND_URL, credentials: true }));\napp.use(express.json());\napp.use(morgan(\"dev\"));\n\napp.use(\n  session({\n    store: redisStore,\n    secret: process.env.SESSION_SECRET || \"\",\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      secure: process.env.NODE_ENV === \"production\",\n      httpOnly: true,\n      maxAge: 1000 * 60 * 60 * 24,\n      sameSite: \"lax\",\n    },\n  }),\n);\n\napp.use(\"/api/auth\", routerAuth);\n\napp.listen(3000, () => {\n  console.log(\"Server up of auth-service http://localhost:3002\");\n});\n","import { Router, Request } from \"express\";\nimport bcrypt from \"bcryptjs\";\nimport { login, createUser } from \"../services/auth.service\";\nimport { isExistsEmail, isExistsUsername } from \"../services/chekcExists\";\nimport { CreateUserBody, LoginUserBody } from \"../models/user\";\n\nconst router: Router = Router();\n\nrouter.post(\"/login\", async (req: Request<LoginUserBody>, res) => {\n  const { email, password } = req.body;\n\n  if (!email || !password) {\n    return res\n      .status(400)\n      .json({ error: \"El correo y la contraseña son obligatorios.\" });\n  }\n\n  try {\n    const user = await login(req.body);\n\n    if (!user) {\n      return res\n        .status(401)\n        .json({ error: \"Credenciales inválidas o cuenta inactiva\" });\n    }\n\n    const match = await bcrypt.compare(password, user.password_hashed!);\n\n    if (!match) {\n      return res.status(401).json({ error: \"Credenciales inválidas.\" });\n    }\n\n    req.session.userId = user.user_id;\n    req.session.username = user.username;\n    req.session.isAdmin = user.isAdmin;\n\n    res.status(200).json({\n      message: \"Login exitoso\",\n      data: {\n        user_id: user.user_id,\n        username: user.username,\n        email: user.email,\n        role: user.isAdmin ? \"admin\" : \"user\",\n      },\n    });\n  } catch (error) {\n    console.error(\"Error al iniciar sesion:\", error);\n    res.status(500).json({ error: `Error en el servidor: ${error}` });\n  }\n});\n\nrouter.post(\"/register\", async (req: Request<CreateUserBody>, res) => {\n  const { email, username, password } = req.body;\n\n  if (!username || !email || !password) {\n    return res\n      .status(400)\n      .json({ error: \"Faltan los campos username, email o password\" });\n  }\n  try {\n    await isExistsEmail(email, res);\n    await isExistsUsername(username, res);\n\n    const newUser = await createUser(req.body);\n\n    req.session.userId = newUser.user_id;\n    req.session.username = newUser.username;\n\n    res.status(201).json(newUser);\n  } catch (error) {\n    console.error(\"Error al insertar usuario:\", error);\n    res.status(500).json({ error: \"Error interno del servidor\" });\n  }\n});\n\nrouter.post(\"/logout\", (req, res) => {\n  req.session.destroy((err) => {\n    if (err) {\n      return res.status(500).json({ error: \"No se pudo cerrar sesión.\" });\n    }\n    res.clearCookie(\"connect.sid\");\n    res.status(200).json({ message: \"Se cerro sesión exitosamente.\" });\n  });\n});\n\nexport default router;\n","import bcrypt from \"bcryptjs\";\nimport db from \"../config/db.ts\";\nimport { CreateUserBody, LoginUserBody } from \"../models/user.ts\";\n\nexport const createUser = async (data: CreateUserBody) => {\n  const { email, username, password } = data;\n\n  const hashedPassword = await bcrypt.hash(password, 10);\n  const queryText = 'INSERT INTO users(username, email,password_hashed) VALUES($1, $2, $3) RETURNING *';\n  const queryParams = [username, email, hashedPassword];\n\n  const { rows } = await db.query(queryText, queryParams);\n\n\n  const newUser = rows[0];\n\n  delete newUser.password_hashed;\n  delete newUser.updated_at;\n  delete newUser.created_at;\n  delete newUser.address_id;\n\n  return newUser;\n}\n\n\nexport const login = async (data: LoginUserBody) => {\n  const { email } = data;\n\n  const queryText = \"SELECT * FROM users WHERE email = $1 AND  status = 'active'\";\n  const queryParams = [email];\n  const { rows } = await db.query(queryText, queryParams);\n\n  const user = rows[0];\n\n  return user;\n}\n\n\n","import pg, { QueryResultRow } from \"pg\";\nimport { QueryResult } from \"pg\";\n\nconst { Pool } = pg;\n\nconst DB_PORT = parseInt(process.env.DB_PORT || \"5432\", 10);\n\nconst pool = new Pool({\n  user: process.env.DB_USER,\n  host: process.env.DB_HOST,\n  database: process.env.DB_DATABASE,\n  password: process.env.DB_PASSWORD,\n  port: DB_PORT,\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\nconst db = {\n  query: <T extends QueryResultRow = any>(\n    text: string,\n    params?: any[],\n  ): Promise<QueryResult<T>> => {\n    return pool.query<T>(text, params);\n  },\n};\n\nexport default db;\n","import { Response } from \"express\";\nimport db from \"../config/db.ts\";\n\nexport const isExistsEmail = async (email: string, res: Response) => {\n  const queryText = 'SELECT 1 FROM users WHERE email = $1';\n  const queryParams = [email];\n  const { rows } = await db.query(queryText, queryParams);\n\n  if (rows.length > 0) {\n    return res.status(400).json({ error: \"Ya existe este correo.\" });\n  }\n\n  return null;\n}\n\n\nexport const isExistsUsername = async (username: string, res: Response) => {\n  const queryText = 'SELECT 1 FROM users WHERE username = $1';\n  const queryParams = [username];\n  const { rows } = await db.query(queryText, queryParams);\n\n  if (rows.length > 0) {\n    return res.status(400).json({ error: \"Ya existe este nombre de usuario.\" });\n  }\n  return null;\n}\n\nexport const isActiveUser = async (userId: number): Promise<boolean> => {\n  const queryText = \"SELECT 1 FROM users WHERE user_id = $1 and status = 'active'\";\n  const queryParams = [userId];\n  const { rows } = await db.query(queryText, queryParams);\n\n  if (rows.length > 0) {\n    return false\n  }\n  return true\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAAA,kBAAoB;AACpB,oBAAmB;AACnB,6BAAoB;AACpB,mBAA6B;AAC7B,2BAA2B;;;ACJ3B,qBAAgC;AAChC,IAAAC,mBAAmB;;;ACDnB,sBAAmB;;;ACAnB,gBAAmC;AAGnC,IAAM,EAAE,KAAK,IAAI,UAAAC;AAEjB,IAAM,UAAU,SAAS,QAAQ,IAAI,WAAW,QAAQ,EAAE;AAE1D,IAAM,OAAO,IAAI,KAAK;AAAA,EACpB,MAAM,QAAQ,IAAI;AAAA,EAClB,MAAM,QAAQ,IAAI;AAAA,EAClB,UAAU,QAAQ,IAAI;AAAA,EACtB,UAAU,QAAQ,IAAI;AAAA,EACtB,MAAM;AAAA,EACN,KAAK;AAAA,EACL,mBAAmB;AAAA,EACnB,yBAAyB;AAC3B,CAAC;AAED,IAAM,KAAK;AAAA,EACT,OAAO,CACL,MACA,WAC4B;AAC5B,WAAO,KAAK,MAAS,MAAM,MAAM;AAAA,EACnC;AACF;AAEA,IAAO,aAAQ;;;ADvBR,IAAM,aAAa,OAAO,SAAyB;AACxD,QAAM,EAAE,OAAO,UAAU,SAAS,IAAI;AAEtC,QAAM,iBAAiB,MAAM,gBAAAC,QAAO,KAAK,UAAU,EAAE;AACrD,QAAM,YAAY;AAClB,QAAM,cAAc,CAAC,UAAU,OAAO,cAAc;AAEpD,QAAM,EAAE,KAAK,IAAI,MAAM,WAAG,MAAM,WAAW,WAAW;AAGtD,QAAM,UAAU,KAAK,CAAC;AAEtB,SAAO,QAAQ;AACf,SAAO,QAAQ;AACf,SAAO,QAAQ;AACf,SAAO,QAAQ;AAEf,SAAO;AACT;AAGO,IAAM,QAAQ,OAAO,SAAwB;AAClD,QAAM,EAAE,MAAM,IAAI;AAElB,QAAM,YAAY;AAClB,QAAM,cAAc,CAAC,KAAK;AAC1B,QAAM,EAAE,KAAK,IAAI,MAAM,WAAG,MAAM,WAAW,WAAW;AAEtD,QAAM,OAAO,KAAK,CAAC;AAEnB,SAAO;AACT;;;AEhCO,IAAM,gBAAgB,OAAO,OAAe,QAAkB;AACnE,QAAM,YAAY;AAClB,QAAM,cAAc,CAAC,KAAK;AAC1B,QAAM,EAAE,KAAK,IAAI,MAAM,WAAG,MAAM,WAAW,WAAW;AAEtD,MAAI,KAAK,SAAS,GAAG;AACnB,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yBAAyB,CAAC;AAAA,EACjE;AAEA,SAAO;AACT;AAGO,IAAM,mBAAmB,OAAO,UAAkB,QAAkB;AACzE,QAAM,YAAY;AAClB,QAAM,cAAc,CAAC,QAAQ;AAC7B,QAAM,EAAE,KAAK,IAAI,MAAM,WAAG,MAAM,WAAW,WAAW;AAEtD,MAAI,KAAK,SAAS,GAAG;AACnB,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAAA,EAC5E;AACA,SAAO;AACT;;;AHnBA,IAAM,aAAiB,uBAAO;AAE9B,OAAO,KAAK,UAAU,OAAO,KAA6B,QAAQ;AAChE,QAAM,EAAE,OAAO,SAAS,IAAI,IAAI;AAEhC,MAAI,CAAC,SAAS,CAAC,UAAU;AACvB,WAAO,IACJ,OAAO,GAAG,EACV,KAAK,EAAE,OAAO,iDAA8C,CAAC;AAAA,EAClE;AAEA,MAAI;AACF,UAAM,OAAO,MAAM,MAAM,IAAI,IAAI;AAEjC,QAAI,CAAC,MAAM;AACT,aAAO,IACJ,OAAO,GAAG,EACV,KAAK,EAAE,OAAO,8CAA2C,CAAC;AAAA,IAC/D;AAEA,UAAM,QAAQ,MAAM,iBAAAC,QAAO,QAAQ,UAAU,KAAK,eAAgB;AAElE,QAAI,CAAC,OAAO;AACV,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6BAA0B,CAAC;AAAA,IAClE;AAEA,QAAI,QAAQ,SAAS,KAAK;AAC1B,QAAI,QAAQ,WAAW,KAAK;AAC5B,QAAI,QAAQ,UAAU,KAAK;AAE3B,QAAI,OAAO,GAAG,EAAE,KAAK;AAAA,MACnB,SAAS;AAAA,MACT,MAAM;AAAA,QACJ,SAAS,KAAK;AAAA,QACd,UAAU,KAAK;AAAA,QACf,OAAO,KAAK;AAAA,QACZ,MAAM,KAAK,UAAU,UAAU;AAAA,MACjC;AAAA,IACF,CAAC;AAAA,EACH,SAAS,OAAO;AACd,YAAQ,MAAM,4BAA4B,KAAK;AAC/C,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yBAAyB,KAAK,GAAG,CAAC;AAAA,EAClE;AACF,CAAC;AAED,OAAO,KAAK,aAAa,OAAO,KAA8B,QAAQ;AACpE,QAAM,EAAE,OAAO,UAAU,SAAS,IAAI,IAAI;AAE1C,MAAI,CAAC,YAAY,CAAC,SAAS,CAAC,UAAU;AACpC,WAAO,IACJ,OAAO,GAAG,EACV,KAAK,EAAE,OAAO,+CAA+C,CAAC;AAAA,EACnE;AACA,MAAI;AACF,UAAM,cAAc,OAAO,GAAG;AAC9B,UAAM,iBAAiB,UAAU,GAAG;AAEpC,UAAM,UAAU,MAAM,WAAW,IAAI,IAAI;AAEzC,QAAI,QAAQ,SAAS,QAAQ;AAC7B,QAAI,QAAQ,WAAW,QAAQ;AAE/B,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO;AAAA,EAC9B,SAAS,OAAO;AACd,YAAQ,MAAM,8BAA8B,KAAK;AACjD,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6BAA6B,CAAC;AAAA,EAC9D;AACF,CAAC;AAED,OAAO,KAAK,WAAW,CAAC,KAAK,QAAQ;AACnC,MAAI,QAAQ,QAAQ,CAAC,QAAQ;AAC3B,QAAI,KAAK;AACP,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+BAA4B,CAAC;AAAA,IACpE;AACA,QAAI,YAAY,aAAa;AAC7B,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,SAAS,mCAAgC,CAAC;AAAA,EACnE,CAAC;AACH,CAAC;AAED,IAAO,qBAAQ;;;AD/Ef,kBAAiB;AAEjB,IAAM,kBAAc,2BAAa;AAAA,EAC/B,KAAK,QAAQ,IAAI,aAAa;AAChC,CAAC;AACD,YAAY,QAAQ,EAAE,MAAM,QAAQ,KAAK;AAEzC,IAAM,aAAa,IAAI,gCAAW;AAAA,EAChC,QAAQ;AAAA,EACR,QAAQ;AACV,CAAC;AAED,IAAM,UAA2B,gBAAAC,SAAQ;AAEzC,IAAI,QAAI,YAAAC,SAAK,EAAE,QAAQ,QAAQ,IAAI,cAAc,aAAa,KAAK,CAAC,CAAC;AACrE,IAAI,IAAI,gBAAAD,QAAQ,KAAK,CAAC;AACtB,IAAI,QAAI,cAAAE,SAAO,KAAK,CAAC;AAErB,IAAI;AAAA,MACF,uBAAAC,SAAQ;AAAA,IACN,OAAO;AAAA,IACP,QAAQ,QAAQ,IAAI,kBAAkB;AAAA,IACtC,QAAQ;AAAA,IACR,mBAAmB;AAAA,IACnB,QAAQ;AAAA,MACN,QAAQ,QAAQ,IAAI,aAAa;AAAA,MACjC,UAAU;AAAA,MACV,QAAQ,MAAO,KAAK,KAAK;AAAA,MACzB,UAAU;AAAA,IACZ;AAAA,EACF,CAAC;AACH;AAEA,IAAI,IAAI,aAAa,kBAAU;AAE/B,IAAI,OAAO,KAAM,MAAM;AACrB,UAAQ,IAAI,iDAAiD;AAC/D,CAAC;","names":["import_express","import_bcryptjs","pg","bcrypt","bcrypt","express","cors","morgan","session"]}
{"version":3,"sources":["../src/index.ts","../src/routes/auth.ts","../src/services/auth.service.ts","../src/config/db.ts","../src/services/chekcExists.ts"],"sourcesContent":["import express from \"express\";\nimport morgan from \"morgan\";\nimport session from \"express-session\";\nimport { createClient } from \"redis\";\nimport { RedisStore } from \"connect-redis\";\nimport routerAuth from \"./routes/auth.ts\";\n\nconst redisClient = createClient({\n  url: process.env.REDIS_URL || 'redis://redis-service:6379'\n});\nredisClient.connect().catch(console.error);\n\nconst redisStore = new RedisStore({\n  client: redisClient,\n  prefix: 'session',\n});\n\nconst app: express.Application = express();\n\napp.use(express.json());\napp.use(morgan('dev'));\n\napp.use(session({\n  store: redisStore,\n  secret: process.env.SESSION_SECRET || '',\n  resave: false,\n  saveUninitialized: false,\n  cookie: {\n    secure: process.env.NODE_ENV === 'production',\n    maxAge: 1000 * 60 * 60 * 24\n  }\n}));\n\napp.use('/api/auth', routerAuth);\n\n\n\napp.listen(3000, () => {\n  console.log(\"Server up of auth-service http://localhost:3002\")\n});\n","import { Router, Request, Response } from \"express\";\nimport bcrypt from \"bcryptjs\";\nimport { login, createUser } from \"../services/auth.service\";\nimport { isExistsEmail, isExistsUsername } from \"../services/chekcExists\";\nimport { CreateUserBody, LoginUserBody, UserResponse } from \"../models/user\";\n\nconst router: Router = Router();\n\nrouter.post('/login', async (req: Request<LoginUserBody>, res: Response<UserResponse>) => {\n  const { email, password } = req.body;\n\n  if (!email || !password) {\n    return res.status(400).json({ error: 'El correo y la contraseña son obligatorios.' });\n  }\n\n  try {\n    const user = await login(req.body)\n\n    if (!user) {\n      return res.status(401).json({ error: 'Credenciales inválidas o cuenta inactiva' });\n    }\n\n    const match = await bcrypt.compare(password, user.password_hashed!)\n\n    if (!match) {\n      return res.status(401).json({ error: 'Credenciales inválidas.' });\n    }\n\n    req.session.userId = user.user_id;\n    req.session.username = user.username;\n\n    res.status(200).json({\n      message: 'Login exitoso',\n      user: {\n        user_id: user.user_id,\n        username: user.username,\n        email: user.email\n      }\n    });\n  } catch (error) {\n    console.error('Error al iniciar sesion:', error);\n    res.status(500).json({ error: `Error en el servidor: ${error}` });\n  }\n})\n\nrouter.post('/register', async (req: Request<CreateUserBody>, res: Response<UserResponse>) => {\n  const { email, username, password } = req.body;\n\n  if (!username || !email || !password) {\n    return res.status(400).json({ error: 'Faltan los campos username, email o password' });\n  }\n  try {\n    await isExistsEmail(email);\n    await isExistsUsername(username);\n\n    const newUser = await createUser(req.body);\n\n    req.session.userId = newUser.user_id;\n    req.session.username = newUser.username;\n\n    res.status(201).json({ user: newUser });\n  } catch (error) {\n    console.error('Error al insertar usuario:', error);\n    res.status(500).json({ error: 'Error interno del servidor' });\n  }\n})\n\nrouter.post('/logout', (req, res) => {\n  req.session.destroy((err) => {\n    if (err) {\n      return res.status(500).json({ error: 'No se pudo cerrar sesión.' });\n    }\n    res.clearCookie('connect.sid');\n    res.status(200).json({ message: 'Se cerro sesión exitosamente.' })\n  })\n});\n\nexport default router;\n\n\n","import bcrypt from \"bcryptjs\";\nimport db from \"../config/db.ts\";\nimport { CreateUserBody, LoginUserBody } from \"../models/user.ts\";\n\nexport const createUser = async (data: CreateUserBody) => {\n  const { email, username, password } = data;\n\n  const hashedPassword = await bcrypt.hash(password, 10);\n  const queryText = 'INSERT INTO users(username, email,password_hashed) VALUES($1, $2, $3) RETURNING *';\n  const queryParams = [username, email, hashedPassword];\n\n  const { rows } = await db.query(queryText, queryParams);\n\n\n  const newUser = rows[0];\n\n  delete newUser.password_hashed;\n  delete newUser.updated_at;\n  delete newUser.created_at;\n  delete newUser.address_id;\n\n  return newUser;\n}\n\n\nexport const login = async (data: LoginUserBody) => {\n  const { email } = data;\n\n  const queryText = \"SELECT * FROM users WHERE email = $1 AND status = 'active'\";\n  const queryParams = [email];\n  const { rows } = await db.query(queryText, queryParams);\n\n  const user = rows[0];\n\n  return user;\n}\n\n","import pg from \"pg\";\nimport { QueryResult } from \"pg\";\nimport { UserModel } from \"../models/user\";\n\nconst { Pool } = pg;\n\nconst DB_PORT = parseInt(process.env.DB_PORT || '5432', 10);\n\n\nconst pool = new Pool({\n  user: process.env.DB_USER,\n  host: process.env.DB_HOST,\n  database: process.env.DB_DATABASE,\n  password: process.env.DB_PASSWORD,\n  port: DB_PORT,\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n})\n\nconst db = {\n  query: (text: string, params?: any[]): Promise<QueryResult<UserModel>> => pool.query(text, params),\n};\n\nexport default db;\n","import db from \"../config/db.ts\";\n\nexport const isExistsEmail = async (email: string) => {\n  const queryText = 'SELECT 1 FROM users WHERE email = $1';\n  const queryParams = [email];\n  const { rows } = await db.query(queryText, queryParams);\n\n  return rows.length > 0;\n}\n\n\nexport const isExistsUsername = async (username: string) => {\n  const queryText = 'SELECT 1 FROM users WHERE username = $1';\n  const queryParams = [username];\n  const { rows } = await db.query(queryText, queryParams);\n\n  return rows.length > 0;\n}\n\nexport const isUserActive = async () => {\n\n}\n"],"mappings":"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","names":["import_express","import_bcryptjs","pg","bcrypt","bcrypt","express","morgan","session"]}
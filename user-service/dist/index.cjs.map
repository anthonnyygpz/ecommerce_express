{"version":3,"sources":["../src/index.ts","../src/routes/user.ts","../src/config/db.ts","../src/services/user.service.ts","../src/services/chekcExists.ts"],"sourcesContent":["import express from \"express\";\nimport morgan from \"morgan\";\nimport session from 'express-session';\nimport routerUser from \"./routes/user.js\";\nimport { createClient } from \"redis\";\nimport { RedisStore } from \"connect-redis\";\n\nconst redisClient = createClient({\n  url: process.env.REDIS_URL || 'redis://redis-service:6379'\n});\nredisClient.connect().catch(console.error);\n\nconst redisStore = new RedisStore({\n  client: redisClient,\n  prefix: 'session',\n});\n\nconst app = express();\n\napp.use(express.json());\napp.use(morgan('dev'));\n\napp.use(session({\n  store: redisStore,\n  secret: process.env.SESSION_SECRET || '',\n  resave: false,\n  saveUninitialized: false,\n  cookie: {\n    secure: process.env.NODE_ENV === 'production',\n    httpOnly: true,\n    maxAge: 1000 * 60 * 60 * 24 // 1 día\n  }\n}));\n\napp.use('/api/users', routerUser);\n\napp.listen(3000, () => {\n  console.log(\"Server up of user-service http://localhost:3001\");\n});\n\n","import { Router } from \"express\";\nimport { softDeleteUser, updateUser } from \"../services/user.service\";\nimport { isExistsUsername } from \"../services/chekcExists\";\nimport { isAuthenticated } from \"shared/middleware\";\n\nconst router: Router = Router();\n\nrouter.get('/me', isAuthenticated, (req, res) => {\n  res.status(200).json({ id: req.session.userId, username: req.session.username });\n});\n\nrouter.put('/', isAuthenticated, async (req, res) => {\n  const { username } = req.body\n  try {\n    await isExistsUsername(username);\n\n    const userIdFromSession = req.session.userId;\n\n    if (userIdFromSession === undefined) {\n      return res.status(400).json({ error: \"El id del usuario no se encontro.\" });\n    }\n    await updateUser(userIdFromSession, req.body);\n\n    res.status(200).json({ message: 'Se actulizaron los datos exitaosamente.' });\n  } catch (error) {\n    console.error('Error al actualizar los datos:', error);\n    res.status(500).send({ error: `Error en el servidor: ${error}` });\n  }\n});\n\n\nrouter.delete('/', isAuthenticated, async (req, res) => {\n  try {\n    const userIdFromSession = req.session.userId;\n\n\n    if (userIdFromSession === undefined) {\n      return res.status(400).json({ error: \"El id del usuario no se encontro.\" });\n    }\n    const deleteUser = await softDeleteUser(userIdFromSession);\n\n    if (!deleteUser) {\n      return res.status(404).json({ error: 'Usuario no encontrado.' });\n    }\n    req.session.destroy((err) => {\n      if (err) {\n        console.error('Error al cerrar después del soft delete:', err)\n        return res.status(500).json({ error: 'Usuario desactivado,pero fallo el cierre de sesión.' });\n      }\n\n      res.clearCookie('connect.sid');\n      res.status(200).json({\n        message: 'Usuario desactivado y sesión cerrada exitosamente.'\n      })\n    })\n  } catch (error) {\n    console.error('Error en el enpoint de soft delete:', error);\n    res.status(500).json({ error: 'Error interno del servidor.' });\n  }\n})\n\n\nexport default router;\n","import pg from \"pg\";\nimport { QueryResult } from \"pg\";\nimport { UserModel } from \"../models/user\";\n\nconst { Pool } = pg;\n\nconst DB_PORT = parseInt(process.env.DB_PORT || '5432', 10);\n\n\nconst pool = new Pool({\n  user: process.env.DB_USER,\n  host: process.env.DB_HOST,\n  database: process.env.DB_DATABASE,\n  password: process.env.DB_PASSWORD,\n  port: DB_PORT,\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n})\n\nconst db = {\n  query: (text: string, params?: any[]): Promise<QueryResult<UserModel>> => pool.query(text, params),\n};\n\nexport default db;\n","import db from \"../config/db\";\nimport bcrypt from \"bcryptjs\";\nimport { UpdateUserBody } from \"../models/user\";\n\nexport const updateUser = async (userId: number | string, data: UpdateUserBody) => {\n  const { username, address_id, password } = data;\n\n  const setClauses = []; // Almacenará ej: \"username = $1\", \"address_id = $2\"\n  const params = [];     // Almacenará los valores: [\"nuevoUsuario\", 2]\n  let paramIndex = 1;    // Contador para los placeholders ($1, $2, ...)\n\n  // Solo añade campos a la consulta si fueron proporcionados\n  if (username !== undefined) {\n    setClauses.push(`username = $${paramIndex}`);\n    params.push(username);\n    paramIndex++;\n  }\n\n  if (address_id !== undefined) {\n    setClauses.push(`address_id = $${paramIndex}`);\n    params.push(address_id);\n    paramIndex++;\n  }\n\n  if (password) {\n    // Solo hashea si se proporciona una nueva contraseña\n    const passwordHash = await bcrypt.hash(password, 10);\n    setClauses.push(`password_hashed = $${paramIndex}`);\n    params.push(passwordHash);\n    paramIndex++;\n  }\n\n  // Si no se proporcionó ningún dato para actualizar, no hagas nada.\n  if (setClauses.length === 0) {\n    // Opcionalmente, podrías devolver el usuario actual sin cambios\n    // o lanzar un error. Por ahora, devolvemos null.\n    return null;\n  }\n\n  // 2. --- Ejecución de la Consulta Única ---\n\n  // Añade 'updated_at' automáticamente\n  setClauses.push('updated_at = NOW()');\n\n  // El ID del usuario siempre es el último parámetro\n  params.push(userId);\n  const whereClause = `WHERE user_id = $${paramIndex}`;\n\n  // Combina las partes en una sola consulta\n  const queryText = `\n    UPDATE users\n    SET ${setClauses.join(', ')}\n    ${whereClause}\n    RETURNING user_id, username, address_id, status, created_at, updated_at\n  `;\n\n  try {\n    const { rows } = await db.query(queryText, params);\n\n    return rows[0] || null;\n\n  } catch (err) {\n    console.error('Error al actualizar usuario:', err);\n    throw err;\n  }\n}\n\n\nexport const softDeleteUser = async (userId: number | string) => {\n  try {\n    const queryText = \"UPDATE users SET status = 'inactive', updated_at = NOW() WHERE user_id = $1 RETURNING user_id status\";\n    const queryParams = [userId];\n    const { rows } = await db.query(queryText, queryParams);\n    return rows[0] || null;\n  } catch (error) {\n    console.error('Error al desactivar usuario:', error);\n    throw error;\n  }\n}\n","import db from \"../config/db.ts\";\n\nexport const isExistsEmail = async (email: string) => {\n  const queryText = 'SELECT 1 FROM users WHERE email = $1';\n  const queryParams = [email];\n  const { rows } = await db.query(queryText, queryParams);\n\n  return rows.length > 0;\n}\n\n\nexport const isExistsUsername = async (username: string) => {\n  const queryText = 'SELECT 1 FROM users WHERE username = $1';\n  const queryParams = [username];\n  const { rows } = await db.query(queryText, queryParams);\n\n  return rows.length > 0;\n}\n\nexport const isUserActive = async () => {\n\n}\n"],"mappings":"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","names":["import_express","pg","bcrypt","express","morgan","session"]}